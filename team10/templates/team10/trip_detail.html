{% extends "team10/base.html" %}
{% load static %}
{% block title %}Ø¬Ø²Ø¦ÛŒØ§Øª Ø³ÙØ± | Ø§ÛŒØ±Ø§Ù†â€ŒÙ†Ù…Ø§{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'team10/styles/trip-detail.css' %}">
{% endblock %}

{% block content %}
<section class="t10-page t10-trip-detail t10-digit-scope">

  {% if trip %}
        <div class="t10-summary-card">
            <div class="t10-summary-head">
                <h2>Ø¬Ø²Ø¦ÛŒØ§Øª Ø³ÙØ±</h2>
                <p>Ù†Ù…Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ù„ÛŒ Ùˆ Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø±ÙˆØ²Ø§Ù†Ù‡ Ø³ÙØ±.</p>
            </div>
            <div class="t10-summary-grid">
                <div class="t10-info-item">
                    <span class="t10-info-label"><span class="t10-info-icon">ğŸ“</span>Ù…Ù‚ØµØ¯</span>
                    <span class="t10-info-value t10-no-digit">{{ trip.destination_name|default:trip.requirements.destination_name }}</span>
                </div>
                <div class="t10-info-item">
                    <span class="t10-info-label">Ù…Ø¯Øª</span>
                    <span class="t10-info-value">{{ days_count }} Ø±ÙˆØ²</span>
                </div>
                <div class="t10-info-item">
                    <span class="t10-info-label">ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹</span>
                    <span class="t10-info-value">{{ start_at_jalali|default:"â€”" }}</span>
                </div>
                <div class="t10-info-item">
                    <span class="t10-info-label">ÙˆØ¶Ø¹ÛŒØª</span>
                    <span class="t10-info-value t10-status-badge">
                      {% with s=trip.get_status_display|default:"" %}
                        {% with s_lower=s|lower %}
                          {% if s_lower == "draft" %}
                            Ù¾ÛŒØ´â€ŒÙ†ÙˆÛŒØ³
                          {% elif s_lower == "active" %}
                            ÙØ¹Ø§Ù„
                          {% elif s_lower == "finished" or s_lower == "done" or s_lower == "completed" %}
                            ØªÙ…Ø§Ù…â€ŒØ´Ø¯Ù‡
                          {% elif s_lower == "cancelled" or s_lower == "canceled" %}
                            Ù„ØºÙˆØ´Ø¯Ù‡
                          {% else %}
                            {{ s|default:"â€”" }}
                          {% endif %}
                        {% endwith %}
                      {% endwith %}
                    </span>
                </div>
                <div class="t10-info-item">
                    <span class="t10-info-label">ØªØ¹Ø¯Ø§Ø¯ Ù†ÙØ±</span>
                    <span class="t10-info-value">{{ trip.requirements.travelers_count }}</span>
                </div>
                <div class="t10-info-item">
                    <span class="t10-info-label">Ø³Ø·Ø­ Ø¨ÙˆØ¯Ø¬Ù‡</span>
                    <span class="t10-info-value">
                      {% with b=trip.requirements.get_budget_level_display|default:"" %}
                        {% with b_lower=b|lower %}
                          {% if b_lower == "economy" or b_lower == "economic" or b_lower == "economical" %}
                            Ø§Ù‚ØªØµØ§Ø¯ÛŒ
                          {% elif b_lower == "medium" or b_lower == "normal" or b_lower == "standard" or b_lower == "moderate" %}
                            Ù…ØªÙˆØ³Ø·
                          {% elif b_lower == "luxury" or b_lower == "lux" %}
                            Ù„ÙˆÚ©Ø³
                          {% else %}
                            {{ b|default:"â€”" }}
                          {% endif %}
                        {% endwith %}
                      {% endwith %}
                    </span>
                </div>
                <div class="t10-summary-bottom">
                  <div class="t10-summary-bottom__actions">
                    <div class="t10-trip-actions">
                      <a class="t10-btn t10-btn--secondary" href="{% url 'team10:trip_cost' trip.id %}">Ù‡Ø²ÛŒÙ†Ù‡ Ø³ÙØ±</a>
                      <!-- <a class="t10-btn t10-btn--secondary" href="{% url 'team10:trip_styles' trip.id %}">Ø³Ø¨Ú©â€ŒÙ‡Ø§</a> -->
                      <!-- <a class="t10-btn t10-btn--secondary" href="{% url 'team10:trip_replan' trip.id %}">Ø¨Ø§Ø²ØªÙˆÙ„ÛŒØ¯ Ø¨Ø±Ù†Ø§Ù…Ù‡</a> -->
                    </div>
                  </div>
                  <div class="t10-summary-bottom__cost">
                    <div class="t10-info-item t10-info-item--cost t10-total-cost">
                      <span class="t10-info-label">Ù‡Ø²ÛŒÙ†Ù‡ Ú©Ù„</span>
                      <span class="t10-info-value t10-num">
                        {% with c=total_cost %}
                          {% if c %}
                            {{ c|floatformat:0 }} ØªÙˆÙ…Ø§Ù†
                          {% else %}
                            â€”
                          {% endif %}
                        {% endwith %}
                      </span>
                    </div>
                  </div>
                </div>
            </div>
        </div>
        
        <section class="t10-card t10-destination-description">
          <h3 class="t10-section-title">Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ù…Ù‚ØµØ¯</h3>
          <div class="t10-description-content">
            {{ destination_info|linebreaks }}
          </div>
        </section>

  <section class="t10-card">
    <h3>Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø±ÙˆØ²Ø§Ù†Ù‡</h3>

    {% for day in days_list %}
    <div class="t10-day-card">
      <div class="t10-day-header">
        <h4>Ø±ÙˆØ² {{ day.day_number }}</h4>
        <span class="t10-day-date">{{  day.date_jalali }}</span>
      </div>
      
      {% for item in day.activities %}
      
      {% if item.transfer %}
      <div class="t10-transfer-row">
        <span class="t10-transfer-emoji" data-mode="{{ item.transfer.transport_mode }}">ğŸš—</span>
        <span class="t10-transfer-text">
          Ø¬Ø§Ø¨Ø¬Ø§ÛŒÛŒ:
          {% if item.transfer.transport_mode == "WALKING" %}
            Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ±ÙˆÛŒ
          {% elif item.transfer.transport_mode == "TAXI" %}
            ØªØ§Ú©Ø³ÛŒ
          {% elif item.transfer.transport_mode == "PUBLIC_TRANSIT" %}
            Ø­Ù…Ù„â€ŒÙˆÙ†Ù‚Ù„ Ø¹Ù…ÙˆÙ…ÛŒ
          {% elif item.transfer.transport_mode == "DRIVING" %}
            Ø®ÙˆØ¯Ø±Ùˆ Ø´Ø®ØµÛŒ
          {% else %}
            {{ item.transfer.transport_mode }}
          {% endif %}
          | {{ item.transfer.distance_km }} Ú©ÛŒÙ„ÙˆÙ…ØªØ±
          | {{ item.transfer.duration_minutes }} Ø¯Ù‚ÛŒÙ‚Ù‡
          {% if item.transfer.cost > 0 %}
          | Ù‡Ø²ÛŒÙ†Ù‡: {{ item.transfer.cost|floatformat:0 }} ØªÙˆÙ…Ø§Ù†
          {% endif %}
        </span>
      </div>
      {% endif %}
      
      <div class="t10-activity-row" data-activity-type="{{ item.activity_type_fa }}">
        <div class="t10-activity-time">
          {{ item.plan.start_at|date:"H:i" }} ØªØ§ {{ item.plan.end_at|date:"H:i" }}
        </div>
        <div class="t10-activity-main">
          <div class="t10-activity-title">{{ item.plan.description|truncatechars:50|default:"-" }}</div>
          <div class="t10-activity-meta">
            <span class="t10-type-badge">
              <span class="t10-type-emoji" aria-hidden="true"></span>
              <span class="t10-type-text">{{ item.activity_type_fa }}</span>
            </span>
            <span class="t10-activity-cost">{{ item.plan.cost|floatformat:0|default:"0" }} ØªÙˆÙ…Ø§Ù†</span>
          </div>
        </div>
      </div>
      
      {% endfor %}
    </div>
    {% empty %}
    <div class="t10-day-card">
      <div class="t10-activity-empty">
        <div>Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ø³ÙØ± Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</div>
      </div>
    </div>
    {% endfor %}
  </section>

  <section class="t10-card">
    <h3>Ù‡ØªÙ„â€ŒÙ‡Ø§</h3>
    {% for hotel in hotel_schedules %}
    <div class="t10-day-card t10-hotel-card">
      <div class="t10-activity-row">
        <div class="t10-activity-time">ğŸ¨ Ù‡ØªÙ„</div>
        <div class="t10-activity-main">
          <div class="t10-activity-title">{{ hotel.hotel_name }}</div>
          <div class="t10-activity-meta">
            <span class="t10-type-badge">Ø§ØªØ§Ù‚â€ŒÙ‡Ø§: {{ hotel.rooms_count }}</span>
            <span class="t10-activity-cost">{{ hotel.cost|floatformat:0 }} ØªÙˆÙ…Ø§Ù†</span>
          </div>
        </div>
        <!-- <div class="t10-activity-emoji" aria-hidden="true">ğŸ¨</div> -->
      </div>
      <div class="t10-transfer-row">
        <span class="t10-transfer-emoji">ğŸ“…</span>
        <span class="t10-transfer-text">Ø¨Ø§Ø²Ù‡ Ø§Ù‚Ø§Ù…Øª: {{ hotel.start_at_jalali|default:"-" }} ØªØ§ {{ hotel.end_at_jalali|default:"-" }}</span>
      </div>
    </div>
    {% empty %}
    <div class="t10-day-card">
      <div class="t10-activity-empty">
        <div>Ù‡ØªÙ„ÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ø³ÙØ± Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</div>
      </div>
    </div>
    {% endfor %}
  </section>

  {% else %}
  <section class="t10-card">
    <h3>Ø¬Ø²Ø¦ÛŒØ§Øª Ø³ÙØ±</h3>
    <p>Ø³ÙØ± Ù…ÙˆØ±Ø¯Ù†Ø¸Ø± Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯.</p>
  </section>
  {% endif %}
</section>

<!-- Timeline -->
<div class="t10-timeline-floating" aria-label="Ø®Ø· Ø²Ù…Ø§Ù† Ø³ÙØ±">
  <div class="t10-timeline-line">
    <div class="t10-timeline-progress"></div>
  </div>
  <ol class="t10-timeline-dots" id="t10TimelineDots"></ol>
</div>

<script>
  (function() {
    function toPersianDigits(value) {
      return String(value).replace(/\d/g, function(digit) {
        return "Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹"[digit];
      });
    }

    function replaceDigitsInNode(node) {
      if (!node || !node.nodeValue) return;
      node.nodeValue = toPersianDigits(node.nodeValue);
    }

    function shouldSkipNode(node) {
      if (!node || !node.parentElement) return true;
      if (node.parentElement.closest('.t10-no-digit')) return true;
      if (node.parentElement.closest('script, style, input, textarea, select, option')) return true;
      return false;
    }

    function convertAllDigits() {
      const scope = document.querySelector('.t10-digit-scope');
      if (!scope) return;
      const walker = document.createTreeWalker(scope, NodeFilter.SHOW_TEXT, null);
      let current;
      while ((current = walker.nextNode())) {
        if (shouldSkipNode(current)) continue;
        replaceDigitsInNode(current);
      }
    }

    function setActivityEmojis() {
      const map = [
        { keys: ["ØºØ°Ø§", "Ø±Ø³ØªÙˆØ±Ø§Ù†", "Food", "Restaurant", "Meal"], emoji: "ğŸ½ï¸" },
        { keys: ["Ú¯Ø±Ø¯Ø´Ú¯Ø±ÛŒ", "Ø¬Ø§Ø°Ø¨Ù‡", "Attraction", "Sightseeing", "Tourism"], emoji: "ğŸ›ï¸" },
        { keys: ["ÙØ±Ù‡Ù†Ú¯ÛŒ", "Culture", "Cultural", "Museum", "Art"], emoji: "ğŸ­" },
        { keys: ["Ø®Ø±ÛŒØ¯", "Shopping", "Mall", "Market"], emoji: "ğŸ›ï¸" },
        { keys: ["Ø·Ø¨ÛŒØ¹Øª", "Nature", "Park", "Forest"], emoji: "ğŸŒ¿" },
        { keys: ["Ù‡ØªÙ„", "Ø§Ù‚Ø§Ù…Øª", "Hotel", "Stay", "Lodging"], emoji: "ğŸ¨" },
        { keys: ["Ø§Ø³ØªØ±Ø§Ø­Øª", "Relax", "Rest"], emoji: "ğŸ§˜" }
      ];

      document.querySelectorAll('.t10-activity-row[data-activity-type]').forEach(function(row) {
        const type = (row.getAttribute('data-activity-type') || '').trim();
        const hit = map.find(function(m) {
          return m.keys.some(function(k) { return type.toLowerCase().includes(String(k).toLowerCase()); });
        });
        const emoji = hit ? hit.emoji : "ğŸ“";
        const badgeEmoji = row.querySelector('.t10-type-emoji');
        if (badgeEmoji) badgeEmoji.textContent = emoji;
      });

      document.querySelectorAll('.t10-transfer-emoji[data-mode]').forEach(function(el) {
        const mode = (el.getAttribute('data-mode') || '').toUpperCase();
        const rowText = (el.closest('.t10-transfer-row') || {}).textContent || "";
        if (mode === "WALKING" || rowText.indexOf("Ù¾ÛŒØ§Ø¯Ù‡") !== -1) el.textContent = "ğŸš¶";
        else if (mode === "PUBLIC_TRANSIT") el.textContent = "ğŸšŒ";
        else if (mode === "TAXI") el.textContent = "ğŸš•";
        else el.textContent = "ğŸš—";
      });
    }

    function initFloatingTimeline() {
      const itineraryCard = Array.from(document.querySelectorAll('.t10-card')).find(function(card) {
      const h3 = card.querySelector('h3');
      return h3 && (h3.textContent || '').trim().includes('Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø±ÙˆØ²Ø§Ù†Ù‡');
    });

    const days = itineraryCard
      ? itineraryCard.querySelectorAll('.t10-day-card:not(.t10-hotel-card)')
      : document.querySelectorAll('.t10-day-card:not(.t10-hotel-card)');

      const dotsWrap = document.getElementById('t10TimelineDots');
      const progressEl = document.querySelector('.t10-timeline-progress');

      if (!days.length || !dotsWrap || !progressEl) return;

      // create dots from existing days
      days.forEach((day, i) => {
        const dayNum = (day.querySelector('.t10-day-header h4')?.textContent || '').replace(/\D/g, '') || (i + 1);

        day.id = day.id || `t10-day-${i + 1}`;

        const li = document.createElement('li');
        const a = document.createElement('a');
        a.href = `#${day.id}`;
        a.className = 't10-timeline-dot';
        a.textContent = dayNum;

        li.appendChild(a);
        dotsWrap.appendChild(li);
      });

      function updateTimeline() {
        const first = days[0].getBoundingClientRect();
        const last = days[days.length - 1].getBoundingClientRect();
        const vh = window.innerHeight || 1;

        const total = (last.top - first.top) || 1;
        const passed = vh * 0.4 - first.top;
        const p = Math.max(0, Math.min(1, passed / total));

        progressEl.style.height = (p * 100) + '%';

        const dots = document.querySelectorAll('.t10-timeline-dot');
        const n = dots.length;

        // active index based on progress, so it matches the progress line
        let activeIndex = 0;
        if (n > 1) {
          activeIndex = Math.min(n - 1, Math.floor(p * (n - 1) + 1e-6));
        }

        // mark active (and optionally passed)
        dots.forEach((dot, i) => {
          dot.classList.toggle('is-active', i === activeIndex);
          dot.classList.toggle('is-passed', i < activeIndex);
        });
      }

      window.addEventListener('scroll', updateTimeline, { passive: true });
      window.addEventListener('resize', updateTimeline);
      updateTimeline();
    }

    document.addEventListener('DOMContentLoaded', function() {
      setActivityEmojis();
      convertAllDigits();
      initFloatingTimeline();
    });
  })();
</script>
{% endblock %}
